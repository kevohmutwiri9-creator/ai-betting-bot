\"\"\"\nUnit Tests for AI Betting Bot\n\"\"\"\n\nimport pytest\nimport numpy as np\nimport pandas as pd\nfrom datetime import datetime, timedelta\nimport sys\nimport os\n\n# Add parent directory to path\nsys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))\n\nfrom ai_model import BettingAIModel\nfrom value_detector import ValueBetDetector\n\n\nclass TestBettingAIModel:\n    \"\"\"Test cases for BettingAIModel\"\"\"\n    \n    @pytest.fixture\n    def ai_model(self, tmp_path):\n        \"\"\"Create a test AI model instance\"\"\"\n        model_path = str(tmp_path / \"test_model.pkl\")\n        return BettingAIModel(model_path=model_path)\n    \n    def test_calculate_team_strength_default(self, ai_model):\n        \"\"\"Test that unknown teams return default strength\"\"\"\n        strength = ai_model.calculate_team_strength(\"Unknown Team\")\n        assert 0 <= strength <= 1\n        assert strength == 0.5  # Default should be 0.5\n    \n    def test_calculate_team_strength_cache(self, ai_model):\n        \"\"\"Test that team strength is cached\"\"\"\n        # First call\n        strength1 = ai_model.calculate_team_strength(\"Test Team\")\n        \n        # Second call should use cache\n        cache_before = len(ai_model.team_strengths_cache)\n        strength2 = ai_model.calculate_team_strength(\"Test Team\")\n        \n        # Cache should have increased\n        assert len(ai_model.team_strengths_cache) > 0\n        assert strength1 == strength2\n    \n    def test_calculate_form_no_matches(self, ai_model):\n        \"\"\"Test form calculation for team with no matches\"\"\"\n        form = ai_model.calculate_form(\"Unknown Team\")\n        assert 0 <= form <= 1\n        assert form == 0.5  # Default\n    \n    def test_calculate_head_to_head_no_matches(self, ai_model):\n        \"\"\"Test H2H for teams with no previous matches\"\"\"\n        h2h = ai_model.calculate_head_to_head(\"Team A\", \"Team B\")\n        \n        assert 'home_wins' in h2h\n        assert 'away_wins' in h2h\n        assert 'draws' in h2h\n        assert 'avg_goals' in h2h\n        \n        assert h2h['home_wins'] == 0\n        assert h2h['away_wins'] == 0\n        assert h2h['draws'] == 0\n    \n    def test_prepare_training_data(self, ai_model):\n        \"\"\"Test training data preparation\"\"\"\n        # Create sample match data\n        data = pd.DataFrame([\n            {\n                'home_team': 'Team A',\n                'away_team': 'Team B',\n                'home_odds': 2.0,\n                'draw_odds': 3.0,\n                'away_odds': 4.0,\n                'home_goals': 2,\n                'away_goals': 1\n            },\n            {\n                'home_team': 'Team C',\n                'away_team': 'Team D',\n                'home_odds': 1.5,\n                'draw_odds': 3.5,\n                'away_odds': 6.0,\n                'home_goals': 1,\n                'away_goals': 1\n            }\n        ])\n        \n        features, labels = ai_model.prepare_training_data(data)\n        \n        assert features.shape[0] == 2\n        assert labels.shape[0] == 2\n        assert len(features.shape) == 2  # 2D array\n        \n        # Check labels (first match: home win = 2)\n        assert labels[0] == 2\n        # Check labels (second match: draw = 1)\n        assert labels[1] == 1\n    \n    def test_generate_sample_training_data(self, ai_model):\n        \"\"\"Test sample training data generation\"\"\"\n        data = ai_model.generate_sample_training_data(num_samples=100)\n        \n        assert len(data) == 100\n        assert 'home_team' in data.columns\n        assert 'away_team' in data.columns\n        assert 'home_odds' in data.columns\n        assert 'away_odds' in data.columns\n        assert 'home_goals' in data.columns\n        assert 'away_goals' in data.columns\n    \n    def test_train_model(self, ai_model):\n        \"\"\"Test model training\"\"\"\n        # Generate training data\n        data = ai_model.generate_sample_training_data(num_samples=200)\n        features, labels = ai_model.prepare_training_data(data)\n        \n        # Train model\n        accuracy = ai_model.train_model(features, labels)\n        \n        assert ai_model.is_trained\n        assert 0 <= accuracy <= 1\n        \n        # Check model file was created\n        assert os.path.exists(ai_model.model_path)\n    \n    def test_predict_match_outcome(self, ai_model):\n        \"\"\"Test match outcome prediction\"\"\"\n        # Train model first\n        data = ai_model.generate_sample_training_data(num_samples=200)\n        features, labels = ai_model.prepare_training_data(data)\n        ai_model.train_model(features, labels)\n        \n        # Test prediction\n        sample_features = [0.75, 0.70, 1.0, 2.10, 3.40, 3.20]\n        prediction = ai_model.predict_match_outcome(sample_features)\n        \n        assert 'home_win_prob' in prediction\n        assert 'draw_prob' in prediction\n        assert 'away_win_prob' in prediction\n        \n        # Probabilities should sum to ~1\n        total = sum(prediction.values())\n        assert 0.99 <= total <= 1.01\n    \n    def test_load_save_model(self, ai_model, tmp_path):\n        \"\"\"Test model saving and loading\"\"\"\n        # Train and save\n        data = ai_model.generate_sample_training_data(num_samples=100)\n        features, labels = ai_model.prepare_training_data(data)\n        ai_model.train_model(features, labels)\n        \n        # Create new model instance\n        new_model = BettingAIModel(model_path=ai_model.model_path)\n        new_model.load_model()\n        \n        assert new_model.is_trained\n        assert new_model.model is not None\n\n\nclass TestValueBetDetector:\n    \"\"\"Test cases for ValueBetDetector\"\"\"\n    \n    @pytest.fixture\n    def detector(self, tmp_path):\n        \"\"\"Create a test value detector instance\"\"\"\n        model_path = str(tmp_path / \"test_model.pkl\")\n        return ValueBetDetector(model_path=model_path)\n    \n    def test_calculate_implied_probability(self, detector):\n        \"\"\"Test implied probability calculation\"\"\"\n        # Decimal odds of 2.0 = 50% probability\n        prob = detector.calculate_implied_probability(2.0)\n        assert abs(prob - 0.5) < 0.001\n        \n        # Decimal odds of 4.0 = 25% probability\n        prob = detector.calculate_implied_probability(4.0)\n        assert abs(prob - 0.25) < 0.001\n    \n    def test_calculate_bookmaker_margin(self, detector):\n        \"\"\"Test bookmaker margin calculation\"\"\"\n        margin = detector.calculate_bookmaker_margin(2.0, 3.5, 4.0)\n        \n        # Margin should be positive (bookmaker's edge)\n        assert margin > 0\n        \n        # With fair odds (no margin), should be 0\n        # Home: 1/2 = 0.5, Draw: 1/3.33 = 0.3, Away: 1/4 = 0.25\n        # Total = 1.05, margin = 0.05\n        assert abs(margin - 0.05) < 0.01\n    \n    def test_calculate_kelly_stake_positive(self, detector):\n        \"\"\"Test Kelly calculation for positive edge\"\"\"\n        # 60% chance of winning at 2.0 odds\n        # Kelly = (2.0 * 0.6 - 0.4) / (2.0 - 1) = 0.8\n        kelly = detector.calculate_kelly_stake(0.6, 2.0)\n        \n        assert kelly > 0\n        assert kelly <= 0.10  # Capped at 10%\n    \n    def test_calculate_kelly_stake_negative(self, detector):\n        \"\"\"Test Kelly calculation for negative edge\"\"\"\n        # 30% chance of winning at 2.0 odds (negative edge)\n        kelly = detector.calculate_kelly_stake(0.3, 2.0)\n        \n        assert kelly == 0  # Should not bet\n    \n    def test_calculate_kelly_fraction(self, detector):\n        \"\"\"Test fractional Kelly\"\"\"\n        full_kelly = detector.calculate_kelly_stake(0.6, 2.0, fraction=1.0)\n        half_kelly = detector.calculate_kelly_stake(0.6, 2.0, fraction=0.5)\n        \n        assert half_kelly < full_kelly\n        assert half_kelly == full_kelly * 0.5\n    \n    def test_calculate_expected_value(self, detector):\n        \"\"\"Test expected value calculation\"\"\"\n        # 50% chance at 2.2 odds: EV = 0.5 * 2.2 - 1 = 0.1\n        ev = detector.calculate_expected_value(0.5, 0.45, 2.2)\n        assert ev > 0\n    \n    def test_calculate_confidence(self, detector):\n        \"\"\"Test confidence levels\"\"\"\n        assert detector.calculate_confidence(0.20) == \"High\"\n        assert detector.calculate_confidence(0.12) == \"Medium\"\n        assert detector.calculate_confidence(0.06) == \"Low\"\n\n\nclass TestIntegration:\n    \"\"\"Integration tests for the betting system\"\"\"\n    \n    def test_full_prediction_pipeline(self, tmp_path):\n        \"\"\"Test complete prediction pipeline\"\"\"\n        model_path = str(tmp_path / \"model.pkl\")\n        \n        # Create components\n        ai_model = BettingAIModel(model_path=model_path)\n        detector = ValueBetDetector(model_path=model_path)\n        \n        # Train model\n        data = ai_model.generate_sample_training_data(num_samples=500)\n        features, labels = ai_model.prepare_training_data(data)\n        ai_model.train_model(features, labels)\n        \n        # Create sample match\n        sample_match = pd.DataFrame([{\n            'match_id': 'test_001',\n            'home_team': 'Team A',\n            'away_team': 'Team B',\n            'league': 'Test League',\n            'date': '2024-01-01',\n            'home_odds': 2.10,\n            'draw_odds': 3.40,\n            'away_odds': 3.20\n        }])\n        \n        # Get prediction\n        features = detector.prepare_match_features(sample_match.iloc[0])\n        prediction = ai_model.predict_match_outcome(features)\n        \n        assert prediction['home_win_prob'] > 0\n        assert prediction['draw_prob'] > 0\n        assert prediction['away_win_prob'] > 0\n        \n        # Get value bet\n        value_bets = detector.find_value_bets(sample_match)\n        \n        # Should find value bet or not depending on odds\n        assert isinstance(value_bets, list)\n\n\nif __name__ == \"__main__\":\n    pytest.main([__file__, \"-v\"])\n